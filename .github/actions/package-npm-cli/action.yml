name: 'Package CLI project'
description: 'Package the dotCMS CLI as an NPM project.'
inputs:
  branch:
    description: 'Branch to build from'
    required: false
    default: 'master'
  github-token:
    description: 'GitHub Token'
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    - name: Download Build Artifact
      id: data-download
      uses: dawidd6/action-download-artifact@v3.1.4
      with:
        github_token: ${{ inputs.github-token }}
        workflow: build-test-master.yml
        #commit: ${{ github.sha }}
        workflow_conclusion: success
        search_artifacts: true
        dry_run: true
        name: cli-artifacts-*
        name_is_regexp: true
        path: .
        if_no_artifact_found: warn

    - name: Get SHAs and check if we should deploy
      id: check
      run: |
        build_artifact_exists=${{ steps.data-download.outputs.found_artifact }}
        if [[ ${build_artifact_exists} == "true" ]]; then
            run_id=`echo '${{ steps.data-download.outputs.artifacts }}' | jq -r '.[0].workflow_run.id'`
            found_artifacts=true
            echo "Artifact Run id: $run_id"
        else
           echo "No artifact found"
           run_id="${{ github.run_id }}"
           found_artifacts=false
        fi
        echo "run_id=$run_id" >> $GITHUB_OUTPUT
        echo "found_artifacts=$found_artifacts" >> $GITHUB_OUTPUT
      shell: bash

    - name: 'Download all build artifacts'
      id: download-cli-artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: cli-artifacts-*
        path: ${{ github.workspace }}/artifacts
        github-token: ${{ inputs.github-token }} # token with actions:read permissions on target repo
        merge-multiple: true
        run-id: ${{ steps.check.outputs.run_id }}

    - name: 'List CLI Artifacts'
      if: ${{ steps.check.outputs.found_artifacts == "true" }}
      run: |
        ls -R ${{ github.workspace }}/artifacts
      shell: bash
