name: Reusable CI Build
on:
  workflow_call:
    inputs:
      core-build:
        type: boolean
        default: true
env:
  JVM_TEST_MAVEN_OPTS: "-e -B --no-transfer-progress -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Pprod"

jobs:
  #
  # Initial JDK 11 Build
  # Basic build and install all with maven without running tests.
  # Provides local maven repo for subsequent steps
  #
  build-jdk11:
    name: "Initial Artifact Build"
    runs-on: ubuntu-20.04
    if: inputs.core-build == true
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch base branch
        run: git fetch origin master:refs/remotes/origin/master
      - uses: ./.github/actions/maven-job
        with:
          stage-name: "Initial Artifact Build"
          maven-args: "${{ env.JVM_TEST_MAVEN_OPTS }} clean install -Pvalidate -Dprod=true -Ddocker.buildArchiveOnly=/target --show-version -DskipTests=true  --fail-at-end -Dgithub.event.name=${{ github.event_name }}"
          generate-artifacts: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
