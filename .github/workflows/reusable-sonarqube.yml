name: Reusable CI Build Test
on:
  workflow_call:
    inputs:
      artifact-run-id:
        description: 'The run id of the build to download artifacts from.'
        default: ${{ github.run_id }}
        type: string
    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_HOST_URL:
        required: true

jobs:
  sonarqube:
    name: SonarQube Scan
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/master' || github.event_name == 'pull_request') && github.repository == 'dotCMS/core'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      ## Setup JDK 17 - remove and used default in maven-job when moved to 21
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
      - name: Prepare Maven
        uses: ./.github/actions/maven-job
        with:
          stage-name: "SonarQube Scan"
          no-java: true
          restore-classes: true
          require-master: true
          cache-sonar: true
          maven-args: $JVM_TEST_MAVEN_OPTS -Dsonar.ws.timeout=180 -Dsonar.log.level=DEBUG org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=dotCMS_core_AYSbIemxK43eThAXTlt- -Dsonar.host.url=${SONAR_HOST_URL} -Dsonar.token=$SONAR_TOKEN
      - name: SonarQube Quality Gate check
        id: sonarqube-quality-gate-check
        uses: sonarsource/sonarqube-quality-gate-action@master
        continue-on-error: ${{ github.repository != 'dotCMS/core' }}
        # Force to fail step after specific time.
        timeout-minutes: 10
        with:
          scanMetadataReportFile: target/sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          MAVEN_OPTS: "-Xmx2048m"
      - name: "Example show SonarQube Quality Gate Status value"
        run: echo "The Quality Gate status is ${{ steps.sonarqube-quality-gate-check.outputs.quality-gate-status }}"
